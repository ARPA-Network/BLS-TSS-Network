# ARPA Network L1/L2 Devnet Automation

## Usage

Start Optimism Devnet

```bash
git clone https://github.com/wrinkledeth/optimism
cd optimism
git submodule update --init --recursive
make devnet-up-deploy
```

Build node client (CHECK THIS)

```bash
cd crates/arpa-node
cargo build --bin node-client
``` 

Deploy ARPA Network contracts to L1 and L2 and start randcast nodes

```bash
cd scripts
# activate venv
python3 -m venv .venv
source .venv/bin/activate
# install dependencies
pip3 install -r requirements.txt
# run script
python3 main.py
```

Kill Existing Resources and Start Fresh

```bash
# Kill Arpa Node Containers
docker kill $(docker ps -q -f ancestxor=arpachainio/node:latest); docker rm -f $(docker ps -a -q -f ancestor=arpachainio/node:latest)

# Kill Node Procceses, remove logs and DB files
pkill -f 'node-client -c'
rm -rf /home/ubuntu/BLS-TSS-Network/crates/arpa-node/log
rm /home/ubuntu/BLS-TSS-Network/crates/arpa-node/*.sqlite

#Clean and redploy OP devnet
cd optimism
make devnet-clean
make devnet-up-deploy

# Helpful alias
alias nodekill='pkill -f "node-client -c"; rm -rf /home/ubuntu/BLS-TSS-Network/crates/arpa-node/log; rm /home/ubuntu/BLS-TSS-Network/crates/arpa-node/*.sqlite'

```

Todo 

- [ ] Computer the 3 derived keys at runtime and place into config file
- [ ] Testnet changes
  - [ ] Argparse: (testnet/localnet, silent)
  - [ ] If testnet, don't copy .env.example over .env
  - [ ] Need to add alchemny to .env example
  - [ ] Need to transfer Eth to nodes

## Sample Output

```bash
(.venv) ubuntu@jammy:~/BLS-TSS-Network/scripts$ python3 main.py 
Running Solidity Script: OPControllerOracleLocalTest on L1...
Running Solidity Script: ControllerLocalTest on L1...
Running Solidity Script: OPControllerOracleInitializationLocalTestScript on L2...
Running Solidity Script: InitStakingLocalTestScript on L1...
Running Solidity Script: StakeNodeLocalTestScript on L1...
Starting randcast nodes...
Node 1 started!
Node 2 started!
Node 3 started!
Waiting for nodes to group...
........
Nodes grouped succesfully!
Output:
 {"time":"2023-08-25T23:35:08.410159298+00:00","message":"Group index:0 epoch:1 is available, committers saved.","module_path":"arpa_node::subscriber::post_success_grouping","file":"crates/arpa-node/src/subscriber/post_success_grouping.rs","line":66,"level":"INFO","target":"arpa_node::subscriber::post_success_grouping","thread":"tokio-runtime-worker","thread_id":140504169707072,"node_id":"1","mdc":{},"node_info":"","group_info":""} 

Waiting for DKG Proccess to complete
cast call 0x9d4454B023096f34B160D6B654540c56A1F81688 'getCoordinator(uint256)' 0 --rpc-url http://localhost:8545
.....DKG Proccess Completed Succesfully!
Coordinator Value: 0x0000000000000000000000000000000000000000000000000000000000000000

L1 Group Info:
0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000010078b726ed40b3d410dd9c341a58e67226001de94cdd22e5ccd9745a18da68851322b307ff1dbdf134922475ba5cdf1b4cbc26fedbed71a4c9c2c96f5e7cad3b2e9af28cea23b7e2950172a8705c90b58c69a49c185a42e45d20d82496fa4e510bf15c750de9472ba6a73842ff6baab1112426178820591375cfe48f2fefb5e70000000000000000000000000000000000000000000000000000000000000003000000000000000000000000fabb0ac9d68b0b445fb7357272ff202c5651694a184d8d003598260baa7e90d04971701894ecdad338c95392cbeb47d57b3b99b72dbb477d2f4ad790a0f03eb13b3a3ea414712e6a748064e10cb2d375167a8fb026313df84b9d6a51b9b363cc3261b6b8bde030f607f16cf7d8ad56feba9d4f9d1d4532efe615f62b092c202e91dddab6e533cf8db7a1680feda45e211e15492c00000000000000000000000071be63f3384f5fb98995898a86b02fb2426c5788018f1bdebef6ea3196753fd5749d526e30fc1e930789a8ed2f7c1fd620fe547614701779b94f96832c5911d60bbf2c53b0c5068833296d8fbbeb0fd7656dec1e0a60e2f053740862db3da03ab4e456987f9c624da5a86dd6beec195eaac1e1640e1125fc17e755bd6209c4f0392985eaa603654003f0ce5e6e7217cf5f8a453c000000000000000000000000bcd4042de499d14e55001ccbb24a551f3b954096281cfb5615f51e249acfd43eabfa5e923f87f9f352205b80001a321e4a775f1508dd9f41b0c32a4b46c3883418471a4d76e1bf0095b26d31681d29ed28545957032adc3de7fd64b75e80c22fd21913667df1ca8bd4184ce343bab2112328de1a0e6daa860d49c8ca694a150939f2ce16b3e6c37e207e53ed38bcb9c7b42f5b14000000000000000000000000000000000000000000000000000000000000000300000000000000000000000071be63f3384f5fb98995898a86b02fb2426c5788000000000000000000000000fabb0ac9d68b0b445fb7357272ff202c5651694a000000000000000000000000bcd4042de499d14e55001ccbb24a551f3b95409600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000fabb0ac9d68b0b445fb7357272ff202c5651694a00000000000000000000000071be63f3384f5fb98995898a86b02fb2426c5788000000000000000000000000bcd4042de499d14e55001ccbb24a551f3b95409600000000000000000000000000000000000000000000000000000000000000010078b726ed40b3d410dd9c341a58e67226001de94cdd22e5ccd9745a18da68851322b307ff1dbdf134922475ba5cdf1b4cbc26fedbed71a4c9c2c96f5e7cad3b2e9af28cea23b7e2950172a8705c90b58c69a49c185a42e45d20d82496fa4e510bf15c750de9472ba6a73842ff6baab1112426178820591375cfe48f2fefb5e700000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000

L2 Group Info:
0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000010078b726ed40b3d410dd9c341a58e67226001de94cdd22e5ccd9745a18da68851322b307ff1dbdf134922475ba5cdf1b4cbc26fedbed71a4c9c2c96f5e7cad3b2e9af28cea23b7e2950172a8705c90b58c69a49c185a42e45d20d82496fa4e510bf15c750de9472ba6a73842ff6baab1112426178820591375cfe48f2fefb5e70000000000000000000000000000000000000000000000000000000000000003000000000000000000000000fabb0ac9d68b0b445fb7357272ff202c5651694a184d8d003598260baa7e90d04971701894ecdad338c95392cbeb47d57b3b99b72dbb477d2f4ad790a0f03eb13b3a3ea414712e6a748064e10cb2d375167a8fb026313df84b9d6a51b9b363cc3261b6b8bde030f607f16cf7d8ad56feba9d4f9d1d4532efe615f62b092c202e91dddab6e533cf8db7a1680feda45e211e15492c00000000000000000000000071be63f3384f5fb98995898a86b02fb2426c5788018f1bdebef6ea3196753fd5749d526e30fc1e930789a8ed2f7c1fd620fe547614701779b94f96832c5911d60bbf2c53b0c5068833296d8fbbeb0fd7656dec1e0a60e2f053740862db3da03ab4e456987f9c624da5a86dd6beec195eaac1e1640e1125fc17e755bd6209c4f0392985eaa603654003f0ce5e6e7217cf5f8a453c000000000000000000000000bcd4042de499d14e55001ccbb24a551f3b954096281cfb5615f51e249acfd43eabfa5e923f87f9f352205b80001a321e4a775f1508dd9f41b0c32a4b46c3883418471a4d76e1bf0095b26d31681d29ed28545957032adc3de7fd64b75e80c22fd21913667df1ca8bd4184ce343bab2112328de1a0e6daa860d49c8ca694a150939f2ce16b3e6c37e207e53ed38bcb9c7b42f5b14000000000000000000000000000000000000000000000000000000000000000300000000000000000000000071be63f3384f5fb98995898a86b02fb2426c5788000000000000000000000000fabb0ac9d68b0b445fb7357272ff202c5651694a000000000000000000000000bcd4042de499d14e55001ccbb24a551f3b9540960000000000000000000000000000000000000000000000000000000000000000

Deploying L1 user contract and requesting randomness...
Waiting for randomness to be updated...
.....
Old L1 randomness: 0
New L1 randomness: 114950695450656754918145952855694892685716900033294392146715399121831638328410
L1 Requested Randomness succesfully!

Deploying l2 user contract and requesting randomness...
Waiting for randomness to be updated...
....
Old L2 randomness: 0
New L2 randomness: 62596529619330135978974401853439212939313048136991123484558470331997584900280
L2 Requested Randomness succesfully!
```

## Helpful View Calls for manual debugging

Request randomness:

```bash
# L1
forge script script/GetRandomNumberLocalTest.s.sol:GetRandomNumberLocalTestScript --fork-url http://localhost:8545 --broadcast
# L2
forge script script/OPGetRandomNumberLocalTest.s.sol:OPGetRandomNumberLocalTestScript --fork-url http://localhost:9545 --broadcast 
```

Some view calls:

```bash
# Get latest l1 group info
cast call <Controller> "getGroup(uint256)" 0 --rpc-url http://127.0.0.1:8545
# Check if the latest group info is relayed to L2
cast call <ControllerOracle> "getGroup(uint256)" 0 --rpc-url http://127.0.0.1:9545
# Check if the randomness is successfully fulfilled on L1
cast call <L1_ERC1962Proxy> "getLastRandomness()(uint256)" --rpc-url http://127.0.0.1:8545
# check if the randomness is successfully fulfilled on L2
cast call <L2_ERC1962Proxy> "getLastRandomness()(uint256)" --rpc-url http://127.0.0.1:9545
```

```bash
################ with contract addresses ################
# Get latest l1 group info
cast call 0x9d4454B023096f34B160D6B654540c56A1F81688 "getGroup(uint256)" 0 --rpc-url http://127.0.0.1:8545
# Check if the latest group info is relayed to L2
cast call 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0 "getGroup(uint256)" 0 --rpc-url http://127.0.0.1:9545
# Check if the randomness is successfully fulfilled on L1
cast call 0x809d550fca64d94Bd9F66E60752A544199cfAC3D "getLastRandomness()(uint256)" --rpc-url http://127.0.0.1:8545
# Check if the randomness is successfully fulfilled on L2
cast call 0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9 "getLastRandomness()(uint256)" --rpc-url http://127.0.0.1:9545
``` 